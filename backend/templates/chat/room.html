{% extends 'base.html' %}

{% block title %}{{ room.name }} - Chat - eLearning Platform{% endblock %}

{% block extra_css %}
<style>
    #chat-messages {
        height: 500px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1rem;
        background-color: #f8f9fa;
    }
    .message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 0.5rem;
        max-width: 70%;
    }
    .message-sent {
        background-color: #0d6efd;
        color: white;
        margin-left: auto;
        text-align: right;
    }
    .message-received {
        background-color: white;
        border: 1px solid #dee2e6;
    }
    .message-sender {
        font-weight: bold;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    .message-content {
        margin-bottom: 0.25rem;
        word-wrap: break-word;
    }
    .message-time {
        font-size: 0.75rem;
        opacity: 0.8;
    }
    #message-input {
        resize: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-md-9">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ room.name }}</h5>
                    <a href="{% url 'chat:room_list' %}" class="btn btn-sm btn-light">Back to Rooms</a>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="chat-messages">
                    {% for message in messages %}
                        <div class="message {% if message.sender == user %}message-sent{% else %}message-received{% endif %}">
                            {% if message.sender != user %}
                                <div class="message-sender">{{ message.sender.username }}</div>
                            {% endif %}
                            <div class="message-content">{{ message.content }}</div>
                            <div class="message-time">{{ message.created_at|date:"M d, Y g:i A" }}</div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="card-footer">
                <form id="message-form">
                    <div class="input-group">
                        <textarea id="message-input" class="form-control" placeholder="Type your message..."
                                  rows="2" required></textarea>
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="mb-0">Participants ({{ room.participants.count }})</h6>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    {% for participant in room.participants.all %}
                        <a href="{% url 'accounts:profile' participant.username %}"
                           class="list-group-item list-group-item-action p-2">
                            <div class="d-flex align-items-center">
                                {% if participant.photo %}
                                    <img src="{{ participant.photo.url }}" alt="{{ participant.username }}"
                                         class="rounded-circle me-2" style="width: 35px; height: 35px; object-fit: cover;">
                                {% else %}
                                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2"
                                         style="width: 35px; height: 35px; font-size: 14px;">
                                        {{ participant.username|first|upper }}
                                    </div>
                                {% endif %}
                                <div>
                                    <strong>{{ participant.username }}</strong>
                                    {% if participant == user %}
                                        <span class="badge bg-success" style="font-size: 0.7rem;">You</span>
                                    {% endif %}
                                    <br>
                                    <small class="text-muted">{{ participant.get_user_type_display }}</small>
                                </div>
                            </div>
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Get room ID from the page
    const roomId = {{ room.id }};
    const currentUser = '{{ user.username }}';

    // Determine WebSocket protocol based on current protocol
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';

    // Create WebSocket connection
    const chatSocket = new WebSocket(
        wsProtocol + '//' + window.location.host + '/ws/chat/' + roomId + '/'
    );

    // Get DOM elements
    const messagesContainer = document.getElementById('chat-messages');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');

    // Scroll to bottom of messages
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Initial scroll to bottom
    scrollToBottom();

    // Handle incoming messages
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data.message;
        const sender = data.sender;
        const timestamp = data.timestamp;

        // Create message element
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ' + (sender === currentUser ? 'message-sent' : 'message-received');

        let messageHTML = '';
        if (sender !== currentUser) {
            messageHTML += '<div class="message-sender">' + sender + '</div>';
        }
        messageHTML += '<div class="message-content">' + message + '</div>';
        messageHTML += '<div class="message-time">' + timestamp + '</div>';

        messageDiv.innerHTML = messageHTML;

        // Append to messages container
        messagesContainer.appendChild(messageDiv);

        // Scroll to bottom
        scrollToBottom();
    };

    // Handle WebSocket close
    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
        // Show error message to user
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger mt-3';
        errorDiv.textContent = 'Connection lost. Please refresh the page to reconnect.';
        messagesContainer.appendChild(errorDiv);
    };

    // Handle WebSocket errors
    chatSocket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };

    // Handle form submission
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const message = messageInput.value.trim();

        if (message) {
            // Send message through WebSocket
            chatSocket.send(JSON.stringify({
                'message': message,
                'sender': currentUser
            }));

            // Clear input
            messageInput.value = '';

            // Focus input
            messageInput.focus();
        }
    });

    // Handle Enter key (send message, Shift+Enter for new line)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            messageForm.dispatchEvent(new Event('submit'));
        }
    });

    // Close WebSocket connection when leaving the page
    window.addEventListener('beforeunload', function() {
        chatSocket.close();
    });
</script>
{% endblock %}
