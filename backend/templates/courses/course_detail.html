{% extends 'base.html' %}

{% block title %}{{ course.title }} - eLearning Platform{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-md-8">
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h2 class="card-title">{{ course.title }}</h2>
                        <h5 class="text-muted">{{ course.code }}</h5>
                    </div>
                    <span class="badge {% if course.is_active %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                        {% if course.is_active %}Active{% else %}Inactive{% endif %}
                    </span>
                </div>

                <p class="card-text">{{ course.description }}</p>

                <hr>

                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Teacher:</strong>
                            <a href="{% url 'accounts:profile' course.teacher.username %}">
                                {{ course.teacher.full_name|default:course.teacher.username }}
                            </a>
                        </p>
                        <p><strong>Enrolled Students:</strong> {{ course.get_enrolled_students_count }}</p>
                    </div>
                    <div class="col-md-6">
                        {% if course.start_date %}
                            <p><strong>Start Date:</strong> {{ course.start_date|date:"F d, Y" }}</p>
                        {% endif %}
                        {% if course.end_date %}
                            <p><strong>End Date:</strong> {{ course.end_date|date:"F d, Y" }}</p>
                        {% endif %}
                    </div>
                </div>

                {% if course.get_average_rating %}
                    <p><strong>Average Rating:</strong>
                        {{ course.get_average_rating|floatformat:1 }}/5.0
                        <span class="text-warning">
                            {% with rating=course.get_average_rating %}
                                {% for i in "12345" %}
                                    {% if forloop.counter <= rating %}★{% else %}☆{% endif %}
                                {% endfor %}
                            {% endwith %}
                        </span>
                    </p>
                {% endif %}

                <p class="text-muted"><small>Created {{ course.created_at|date:"F d, Y" }}</small></p>

                <!-- Action Buttons -->
                <div class="mt-4">
                    {% if user == course.teacher %}
                        <a href="{% url 'courses:course_update' course.id %}" class="btn btn-warning">Edit Course</a>
                        <a href="{% url 'courses:upload_material' course.id %}" class="btn btn-success">Upload Material</a>
                        <a href="{% url 'courses:course_delete' course.id %}" class="btn btn-danger">Delete Course</a>
                    {% elif user.is_student %}
                        {% if is_enrolled %}
                            <a href="{% url 'courses:unenroll_course' course.id %}" class="btn btn-warning">Unenroll</a>
                            <a href="{% url 'courses:submit_feedback' course.id %}" class="btn btn-success">Submit Feedback</a>
                        {% else %}
                            <a href="{% url 'courses:enroll_course' course.id %}" class="btn btn-primary">Enroll in Course</a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Course Materials Section -->
        <div class="card shadow mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Course Materials</h5>
                {% if user == course.teacher %}
                    <a href="{% url 'courses:upload_material' course.id %}" class="btn btn-sm btn-success">Upload Material</a>
                {% endif %}
            </div>
            <div class="card-body">
                {% if materials %}
                    <div class="list-group">
                        {% for material in materials %}
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ material.title }}</h6>
                                        <p class="mb-1 text-muted">{{ material.description }}</p>
                                        <small class="text-muted">
                                            <span class="badge bg-info">{{ material.get_material_type_display }}</span>
                                            Uploaded by {{ material.uploaded_by.username }} on {{ material.uploaded_at|date:"M d, Y" }}
                                        </small>
                                    </div>
                                    <div>
                                        {% if is_enrolled or user == course.teacher %}
                                            <a href="{{ material.file.url }}" class="btn btn-sm btn-primary" download>Download</a>
                                        {% endif %}
                                        {% if user == course.teacher %}
                                            <form method="post" action="{% url 'courses:delete_material' material.id %}" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-danger"
                                                        onclick="return confirm('Are you sure you want to delete this material?')">Delete</button>
                                            </form>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No materials uploaded yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Student Feedback Section -->
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">Student Feedback</h5>
            </div>
            <div class="card-body">
                {% if feedbacks %}
                    {% for feedback in feedbacks %}
                        <div class="border-bottom pb-3 mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>
                                        <a href="{% url 'accounts:profile' feedback.student.username %}">
                                            {{ feedback.student.username }}
                                        </a>
                                    </strong>
                                    {% if feedback.rating %}
                                        <span class="text-warning ms-2">
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= feedback.rating %}★{% else %}☆{% endif %}
                                            {% endfor %}
                                        </span>
                                    {% endif %}
                                </div>
                                <small class="text-muted">{{ feedback.created_at|date:"M d, Y" }}</small>
                            </div>
                            <p class="mt-2 mb-0">{{ feedback.comment }}</p>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No feedback yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Enrolled Students (for teacher) -->
        {% if user == course.teacher %}
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Enrolled Students</h5>
                </div>
                <div class="card-body">
                    {% if enrollments %}
                        <div class="list-group">
                            {% for enrollment in enrollments %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <a href="{% url 'accounts:profile' enrollment.student.username %}">
                                                {{ enrollment.student.username }}
                                            </a>
                                            {% if enrollment.completed %}
                                                <span class="badge bg-success ms-2">Completed</span>
                                            {% endif %}
                                        </div>
                                        {% if not enrollment.student.is_blocked %}
                                            <a href="{% url 'courses:block_student' course.id enrollment.student.id %}"
                                               class="btn btn-sm btn-outline-danger">Block</a>
                                        {% else %}
                                            <span class="badge bg-danger">Blocked</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">Enrolled: {{ enrollment.enrolled_at|date:"M d, Y" }}</small>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No students enrolled yet.</p>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- Quick Stats -->
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">Course Statistics</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Total Students</h6>
                    <h3>{{ course.get_enrolled_students_count }}</h3>
                </div>
                <div class="mb-3">
                    <h6>Materials</h6>
                    <h3>{{ materials|length }}</h3>
                </div>
                <div class="mb-3">
                    <h6>Feedback Count</h6>
                    <h3>{{ feedbacks|length }}</h3>
                </div>
                {% if course.get_average_rating %}
                    <div>
                        <h6>Average Rating</h6>
                        <h3>{{ course.get_average_rating|floatformat:1 }}/5.0</h3>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
